# Prismax Backend 测试设计文档

## 1. 项目概述

### 1.1 项目背景
Prismax 是一个机器人远程控制平台，允许用户通过 Web 界面远程控制物理机器人。后端系统包含两个主要服务：
- **用户管理服务**: 处理用户认证、账户管理、支付和积分系统
- **机器人控制服务**: 处理机器人状态、队列管理、控制权限分配

### 1.2 测试目标
- 验证所有 API 接口的功能正确性
- 确保系统在不同场景下的稳定性
- 验证业务逻辑的完整性
- 保证系统的安全性和性能

### 1.3 测试范围

#### 用户管理服务 API (28个端点)
1. 健康检查
2. 用户认证（注册、登录、验证）
3. 用户信息管理
4. 积分系统
5. 支付系统（Stripe、加密货币）
6. 机器人预约
7. 管理员功能
8. 问卷系统

#### 机器人控制服务 API (14个端点)
1. 机器人状态查询
2. 队列管理
3. 机器人控制
4. 控制历史
5. 排行榜
6. 内部服务通信
7. 视觉识别

### 1.4 不在测试范围内
- 前端 UI 测试
- 数据库性能测试
- 第三方服务（Stripe、区块链）的内部逻辑
- WebSocket 实时通信的压力测试

## 2. 测试框架设计

### 2.1 架构设计

```
┌─────────────────────────────────────────────────────────┐
│                    测试框架层                            │
│  ┌────────────┐  ┌────────────┐  ┌─────────────┐       │
│  │  Pytest    │  │   Allure   │  │   Logger    │       │
│  │  Framework │  │   Report   │  │   System    │       │
│  └────────────┘  └────────────┘  └─────────────┘       │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│                    工具封装层                            │
│  ┌────────────┐  ┌────────────┐  ┌─────────────┐       │
│  │   HTTP     │  │   Logger   │  │   Config    │       │
│  │  Request   │  │   Wrapper  │  │   Manager   │       │
│  └────────────┘  └────────────┘  └─────────────┘       │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│                    测试用例层                            │
│  ┌───────────────────┐  ┌─────────────────────┐        │
│  │  User Management  │  │   Tele-Op Service   │        │
│  │    Test Cases     │  │     Test Cases      │        │
│  └───────────────────┘  └─────────────────────┘        │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│                    被测系统                              │
│  ┌───────────────────┐  ┌─────────────────────┐        │
│  │  User Management  │  │   Tele-Op Service   │        │
│  │      Service      │  │      (Flask)        │        │
│  │      (Flask)      │  │                     │        │
│  └───────────────────┘  └─────────────────────┘        │
└─────────────────────────────────────────────────────────┘
```

### 2.2 技术栈
- **测试框架**: Pytest 7.4.3
- **HTTP库**: Requests 2.31.0
- **报告**: Allure 2.13.2
- **日志**: Python logging + colorlog
- **配置管理**: python-dotenv
- **并发执行**: pytest-xdist
- **重试机制**: pytest-rerunfailures

### 2.3 设计原则
1. **模块化**: 工具类独立封装，易于复用和维护
2. **可配置**: 支持多环境配置切换
3. **可扩展**: 易于添加新的测试用例
4. **易读性**: 使用 Allure 注解提供清晰的测试报告
5. **独立性**: 测试用例之间互不依赖
6. **健壮性**: 完善的错误处理和日志记录

## 3. 测试策略

### 3.1 测试级别

#### 3.1.1 单元测试
- 测试单个 API 端点的功能
- 验证输入验证、错误处理
- 覆盖率目标: 80%

#### 3.1.2 集成测试
- 测试多个 API 的交互流程
- 例如：用户注册 → 登录 → 使用机器人的完整流程
- 覆盖主要业务场景

#### 3.1.3 回归测试
- 每次代码更新后执行
- 确保新功能不影响现有功能
- 使用 CI/CD 自动化执行

### 3.2 测试分类

#### 按优先级
- **P0 (Critical)**: 核心功能，必须通过
  - 用户登录
  - 机器人状态查询
  - 队列加入/离开
  - 机器人控制权限获取

- **P1 (High)**: 重要功能
  - 积分系统
  - 支付功能
  - 控制历史
  - 排行榜

- **P2 (Medium)**: 一般功能
  - 用户信息更新
  - 预约功能
  - 问卷系统

- **P3 (Low)**: 辅助功能
  - 管理员功能
  - 统计信息

#### 按测试类型
- **Smoke**: 冒烟测试 (5-10分钟)
- **Regression**: 回归测试 (30-60分钟)
- **Full**: 完整测试 (1-2小时)

### 3.3 测试环境

| 环境 | 用途 | 数据 | 更新频率 |
|------|------|------|----------|
| Local | 开发调试 | 测试数据 | 随时 |
| Beta | 集成测试 | 模拟数据 | 每日 |
| Live | 生产验证 | 真实数据 | 发布前 |

## 4. 测试用例设计

### 4.1 用户管理服务测试用例

#### 4.1.1 健康检查
```
测试ID: UM-HC-001
测试标题: 服务健康检查
优先级: P0
前置条件: 服务已启动
测试步骤:
  1. 发送 GET /health 请求
预期结果: 
  - 状态码: 200
  - 返回服务状态信息
```

#### 4.1.2 用户认证
```
测试ID: UM-AUTH-001
测试标题: 发送邮箱验证码
优先级: P0
前置条件: 邮箱未被注册或已注册
测试步骤:
  1. 准备邮箱和 reCAPTCHA token
  2. 发送 POST /auth/send-verification-code
  3. 验证响应
预期结果:
  - 成功: 200, success=true
  - 失败: 4xx, 包含错误信息
```

```
测试ID: UM-AUTH-002
测试标题: 验证邮箱验证码
优先级: P0
前置条件: 已发送验证码
测试步骤:
  1. 准备邮箱、验证码、reCAPTCHA token
  2. 发送 POST /auth/verify-code
  3. 验证响应和返回的 token
预期结果:
  - 正确验证码: 200, 返回 access_token
  - 错误验证码: 401, 返回错误信息
```

#### 4.1.3 用户信息管理
```
测试ID: UM-USER-001
测试标题: 通过钱包地址获取用户信息
优先级: P0
前置条件: 无
测试步骤:
  1. 准备钱包地址、链类型、reCAPTCHA token
  2. 发送 GET /api/get-users
  3. 验证响应
预期结果:
  - 用户存在: 200, 返回用户信息
  - 用户不存在: 200, 自动创建用户
```

```
测试ID: UM-USER-002
测试标题: 通过邮箱获取用户信息
优先级: P0
前置条件: 用户已登录，有有效 token
测试步骤:
  1. 准备邮箱、token、reCAPTCHA token
  2. 发送 GET /api/get-users (带 Authorization header)
  3. 验证响应
预期结果:
  - Token有效: 200, 返回用户信息
  - Token无效: 401, 返回未授权错误
```

#### 4.1.4 积分系统
```
测试ID: UM-POINTS-001
测试标题: 获取每日登录积分
优先级: P1
前置条件: 用户已登录
测试步骤:
  1. 准备邮箱和 token
  2. 发送 POST /api/daily-login-points
  3. 验证响应和积分变化
预期结果:
  - 首次当日登录: 200, 获得积分
  - 重复登录: 200, 提示已领取
```

#### 4.1.5 支付系统
```
测试ID: UM-PAY-001
测试标题: 创建 Stripe 支付会话
优先级: P1
前置条件: 用户已登录
测试步骤:
  1. 准备邮箱、price_id、quantity、token
  2. 发送 POST /api/create-stripe-checkout-session
  3. 验证返回的 checkout URL
预期结果:
  - 200, 返回有效的 checkout session URL
```

```
测试ID: UM-PAY-002
测试标题: 记录加密货币支付
优先级: P1
前置条件: 用户已登录，有有效的交易签名
测试步骤:
  1. 准备邮箱、钱包地址、交易签名、链、等级、token
  2. 发送 POST /api/record-crypto-payment
  3. 验证支付记录和用户等级升级
预期结果:
  - 交易有效: 200, 用户等级升级
  - 交易无效/重复: 400, 返回错误信息
```

### 4.2 机器人控制服务测试用例

#### 4.2.1 机器人状态
```
测试ID: TO-STATUS-001
测试标题: 获取所有机器人状态
优先级: P0
前置条件: 无
测试步骤:
  1. 发送 GET /robots/status
  2. 验证响应数据结构
预期结果:
  - 200, 返回机器人列表
  - 包含: robot_id, is_available, queue_length, youtube_stream_id, live_paused
```

#### 4.2.2 队列管理
```
测试ID: TO-QUEUE-001
测试标题: 加入机器人队列
优先级: P0
前置条件: 用户已登录，非 Explorer 等级
测试步骤:
  1. 准备 userId, robotId, token
  2. 发送 POST /queue/join
  3. 验证返回的队列位置
预期结果:
  - 成功: 200, 返回 position
  - Explorer 等级: 403, 禁止使用
  - 已在队列: 200, 返回当前 position
```

```
测试ID: TO-QUEUE-002
测试标题: 查询队列状态
优先级: P0
前置条件: 用户已加入队列
测试步骤:
  1. 准备 userId, robotId, token
  2. 发送 POST /queue/status
  3. 验证队列信息和是否轮到
预期结果:
  - 200, 返回 queue 列表和 yourTurn 状态
  - 轮到时返回 controlData
```

```
测试ID: TO-QUEUE-003
测试标题: 离开机器人队列
优先级: P0
前置条件: 用户已在队列中
测试步骤:
  1. 准备 userId, robotId, inactive, token
  2. 发送 POST /queue/leave
  3. 验证队列更新
预期结果:
  - 200, 成功离开队列
  - 如果在使用中，机器人变为可用
```

#### 4.2.3 机器人控制
```
测试ID: TO-CONTROL-001
测试标题: 获取机器人控制权限
优先级: P0
前置条件: 用户在队列首位且状态为 active
测试步骤:
  1. 准备 userId, robotId, token
  2. 发送 POST /use_robot
  3. 验证返回的控制信息
预期结果:
  - 200, 返回 encrypted_url, control_token, expires, isFirstTime
  - 非用户回合: 403, 返回错误
```

```
测试ID: TO-CONTROL-002
测试标题: 获取 URL 解密密钥
优先级: P1
前置条件: 用户已登录，非 Explorer 等级
测试步骤:
  1. 准备 userId, token
  2. 发送 POST /session_url_decrypt_key
  3. 验证返回的密钥
预期结果:
  - 200, 返回 key_b64 和 exp
  - Explorer 等级: 403, 禁止访问
```

#### 4.2.4 控制历史
```
测试ID: TO-HISTORY-001
测试标题: 获取用户控制历史
优先级: P1
前置条件: 用户已登录
测试步骤:
  1. 准备 userId, token
  2. 发送 POST /user/control_history
  3. 验证返回的历史记录
预期结果:
  - 200, 返回 sessions 列表和总计信息
```

```
测试ID: TO-HISTORY-002
测试标题: 获取会话完成状态
优先级: P1
前置条件: 用户有控制会话
测试步骤:
  1. 准备 userId, controlToken, token
  2. 发送 POST /fetch_tele_op_session_complete_status
  3. 验证会话状态和结果
预期结果:
  - 未完成: 200, status="not_finished"
  - 已完成: 200, 返回完整会话数据
```

#### 4.2.5 排行榜
```
测试ID: TO-LEADER-001
测试标题: 获取操控排行榜
优先级: P2
前置条件: 无
测试步骤:
  1. 发送 GET /tele_op/leaderboard
  2. 验证排行榜数据
预期结果:
  - 200, 返回前50名用户
  - 包含: user_id, total_points, rank, controlled_hours
```

#### 4.2.6 内部 API
```
测试ID: TO-INTERNAL-001
测试标题: 机器人断开连接通知
优先级: P1
前置条件: 有 INTERNAL_API_TOKEN
测试步骤:
  1. 准备 robotId, INTERNAL_API_TOKEN
  2. 发送 POST /robot/disconnect
  3. 验证机器人状态更新
预期结果:
  - 200, 用户被移出队列，下一用户激活
  - 401, token 无效
```

```
测试ID: TO-INTERNAL-002
测试标题: 释放机器人
优先级: P1
前置条件: 有 INTERNAL_API_TOKEN
测试步骤:
  1. 准备 robotId, INTERNAL_API_TOKEN
  2. 发送 POST /robot/free
  3. 验证机器人变为可用
预期结果:
  - 200, status="ok"
  - 机器人 is_available=true
```

### 4.3 集成测试用例

#### 4.3.1 完整用户流程
```
测试ID: INT-FLOW-001
测试标题: 新用户注册到控制机器人完整流程
优先级: P0
测试步骤:
  1. 发送验证码到新邮箱
  2. 验证验证码，获取 token
  3. 获取用户信息
  4. 查询机器人状态
  5. 加入队列
  6. 轮询队列状态
  7. 获取控制权限
  8. 使用机器人
  9. 离开队列
  10. 查询控制历史
预期结果: 全流程成功完成
```

#### 4.3.2 支付升级流程
```
测试ID: INT-FLOW-002
测试标题: 用户支付升级等级流程
优先级: P1
测试步骤:
  1. 登录用户
  2. 查询当前等级
  3. 创建支付会话或提交加密货币支付
  4. 验证支付
  5. 查询更新后的等级
  6. 验证新等级的权限
预期结果: 等级升级成功，权限正确
```

#### 4.3.3 队列优先级测试
```
测试ID: INT-FLOW-003
测试标题: Innovator Member 队列优先级
优先级: P1
测试步骤:
  1. Amplifier 用户加入队列（位置1）
  2. 另一个 Amplifier 用户加入（位置2）
  3. Innovator 用户加入队列
  4. 验证 Innovator 被插入到位置2
  5. 验证其他用户位置后移
预期结果: Innovator 正确插队，队列顺序正确
```

## 5. 测试数据设计

### 5.1 测试账号

| 类型 | 邮箱 | 等级 | 用途 |
|------|------|------|------|
| 普通用户 | test_explorer@example.com | Explorer | 测试基础功能 |
| 付费用户1 | test_amplifier@example.com | Amplifier | 测试付费功能 |
| 付费用户2 | test_innovator@example.com | Innovator | 测试高级功能 |
| 管理员 | admin@example.com | Admin | 测试管理功能 |

### 5.2 测试钱包

| 链 | 地址 | 用途 |
|------|------|------|
| Solana | TestSolanaWallet123... | Solana支付测试 |
| Ethereum | 0xTestEthereumWallet... | Ethereum支付测试 |
| Base | 0xTestBaseWallet... | Base支付测试 |

### 5.3 边界值测试

| 测试项 | 边界值 |
|--------|--------|
| 邮箱长度 | 最小3字符，最大254字符 |
| 验证码 | 6位数字 |
| 队列位置 | 1-N |
| 控制时间 | 5分钟 |
| Amplifier arm2使用次数 | 0-3次 |

## 6. 测试报告

### 6.1 报告内容

#### 6.1.1 Allure 报告包含
- 测试执行概览（通过/失败/跳过）
- 按功能模块分类的测试结果
- 每个测试用例的详细步骤
- 失败用例的错误信息和堆栈
- 请求/响应日志
- 执行时间统计
- 趋势分析

#### 6.1.2 日志文件包含
- 所有 HTTP 请求和响应的完整信息
- 断言失败的详细信息
- 异常堆栈跟踪
- 时间戳和日志级别

### 6.2 报告示例

```
测试执行报告
=====================================
执行时间: 2025-10-06 14:30:00
环境: Beta
总用例数: 125
通过: 118 (94.4%)
失败: 5 (4.0%)
跳过: 2 (1.6%)
执行时长: 15分30秒

失败用例:
1. test_join_queue_with_explorer - 用户等级限制验证失败
2. test_crypto_payment_validation - 交易签名验证超时
...

建议:
1. 修复 Explorer 等级判断逻辑
2. 增加区块链 RPC 超时重试机制
```

## 7. 维护和扩展

### 7.1 添加新测试用例

1. 在 `test_cases/` 目录下找到对应的测试文件
2. 创建新的测试方法或测试类
3. 使用 Allure 装饰器标注
4. 编写清晰的文档字符串
5. 实现测试逻辑
6. 运行并验证测试

### 7.2 更新配置

1. 修改 `config.py` 中的环境配置
2. 或使用环境变量覆盖
3. 重新运行测试验证

### 7.3 代码审查清单

- [ ] 测试独立性：测试用例可独立运行
- [ ] 断言清晰：断言失败时有明确提示
- [ ] 文档完整：包含测试目的、步骤、预期结果
- [ ] 错误处理：妥善处理异常情况
- [ ] 日志记录：关键步骤有日志记录
- [ ] 标记正确：使用正确的 pytest 标记
- [ ] 命名规范：遵循命名约定

## 8. 质量保证指标

### 8.1 覆盖率目标
- API 端点覆盖率: 100%
- 业务场景覆盖率: 90%
- 代码分支覆盖率: 80%

### 8.2 测试执行标准
- 冒烟测试: 每次提交执行，耗时 < 10分钟
- 回归测试: 每日执行，耗时 < 1小时
- 完整测试: 发布前执行，耗时 < 2小时

### 8.3 质量门槛
- 通过率 ≥ 95%
- P0 用例通过率 = 100%
- 响应时间 < 3秒 (95th percentile)
- 无 Critical 或 Blocker 缺陷

## 9. 风险和缓解

### 9.1 测试环境风险
- **风险**: 测试环境不稳定
- **缓解**: 多环境配置，使用 mock 数据

### 9.2 数据依赖风险
- **风险**: 测试依赖真实数据
- **缓解**: 创建独立的测试数据，测试后清理

### 9.3 第三方服务风险
- **风险**: Stripe、区块链服务不可用
- **缓解**: 使用测试模式，mock 关键接口

### 9.4 并发测试风险
- **风险**: 并发执行导致数据冲突
- **缓解**: 使用独立的测试账号，避免共享状态

## 10. 持续改进

### 10.1 定期审查
- 每月审查测试用例的有效性
- 删除冗余测试
- 添加新场景测试

### 10.2 性能优化
- 优化慢速测试
- 增加并行执行
- 使用缓存减少重复操作

### 10.3 工具升级
- 定期升级测试框架版本
- 采用新的测试工具和方法
- 学习业界最佳实践

---

**文档版本**: v1.0  
**最后更新**: 2025-10-06  
**维护者**: QA Team

